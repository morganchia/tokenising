<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bond Coupon Trigger</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/Babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Mock bond data
        const mockBond = {
            id: 1,
            name: "Corporate Bond A",
            smartcontractaddress: "0x1234567890abcdef1234567890abcdef12345678",
            campaign: { tokenname: "DSGD" },
            blockchain: 80002,
            totalsupply: 1000000,
            couponrate: 500, // 5% in basis points
            couponinterval: 15768000, // Half-yearly
        };

        // Mock investors and coupon dates
        const mockBondHolders = {
            holders: [
                "0x1111111111111111111111111111111111111111",
                "0x2222222222222222222222222222222222222222"
            ],
            balances: [
                500000 * 1e18,
                500000 * 1e18
            ],
            couponDates: [
                { couponIndex: 1, date: "2025-06-01T00:00:00Z", paid: true },
                { couponIndex: 2, date: "2025-12-01T00:00:00Z", paid: false }
            ],
            lowestUnpaidCouponIndex: 2
        };

        const App = () => {
            const [state, setState] = useState({
                currentBond: {
                    ...mockBond,
                    couponFreq: 'Half-yearly',
                    couponToPay: mockBond.totalsupply * (mockBond.couponinterval / 31536000) * (mockBond.couponrate / 10000),
                    couponRate: mockBond.couponrate,
                    couponAdjustment: 0.5
                },
                bondHolders: mockBondHolders,
                isLoading: false,
                showm: false,
                modalmsg: "",
                button0text: "OK"
            });

            const triggerBondCouponPayment = async () => {
                if (await validateForm()) {
                    setState({ ...state, isLoading: true });
                    // Simulate coupon payment
                    setTimeout(() => {
                        setState({
                            ...state,
                            isLoading: false,
                            showm: true,
                            modalmsg: "Bond coupon payment completed successfully."
                        });
                    }, 2000);
                }
            };

            const validateForm = async () => {
                let err = "";
                if (!state.currentBond.couponToPay) err += "- Coupon amount cannot be empty\n";
                if (state.currentBond.couponToPay <= 0) err += "- Coupon amount must be more than zero\n";
                if (err) {
                    setState({ ...state, showm: true, modalmsg: `Form validation issues found:\n${err}` });
                    return false;
                }
                return true;
            };

            const displayModal = (msg) => {
                setState({ ...state, showm: true, modalmsg: msg });
            };

            const hideModal = () => {
                setState({ ...state, showm: false });
            };

            const shorten = (s) => s ? s.substring(0,6) + "..." + s.slice(-3) : "";

            const blockchainName = {
                80002: 'Polygon Testnet Amoy',
                11155111: 'Ethereum Testnet Sepolia',
                80001: 'Polygon Testnet Mumbai (Deprecated)',
            }[state.currentBond.blockchain] || '';

            return (
                <div className="container mx-auto p-4">
                    {state.isLoading && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                            <div className="spinner"></div>
                        </div>
                    )}
                    <div className="bg-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto">
                        <h3 className="text-xl font-bold mb-4">Trigger Bond Coupon Payment from Issuer Wallet</h3>
                        <form className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Bond Smart Contract Name</label>
                                <input
                                    type="text"
                                    value={state.currentBond.name}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Smart Contract Address</label>
                                <input
                                    type="text"
                                    value={state.currentBond.smartcontractaddress}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Cash Token to be paid as coupon</label>
                                <input
                                    type="text"
                                    value={state.currentBond.campaign.tokenname}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Coupon Amount [{state.currentBond.couponFreq}]</label>
                                <input
                                    type="text"
                                    value={state.currentBond.couponToPay.toLocaleString()}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Coupon Rate (in basis points)</label>
                                <input
                                    type="text"
                                    value={state.currentBond.couponRate}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Blockchain</label>
                                <input
                                    type="text"
                                    value={blockchainName}
                                    disabled
                                    className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Investors</label>
                                {state.bondHolders.holders.length > 0 ? (
                                    <table className="w-full border border-gray-300 mt-2">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border p-2">S/N</th>
                                                <th className="border p-2">Investors</th>
                                                <th className="border p-2">Holdings</th>
                                                <th className="border p-2">Coupon Due</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {state.bondHolders.holders.map((hh, index) => (
                                                <tr key={index}>
                                                    <td className="border p-2">{index + 1}</td>
                                                    <td className="border p-2">{shorten(hh)}</td>
                                                    <td className="border p-2">{(state.bondHolders.balances[index] / 1e18).toLocaleString()}</td>
                                                    <td className="border p-2">
                                                        {((state.bondHolders.balances[index] / 1e18) * (state.currentBond.couponRate / 10000) * state.currentBond.couponAdjustment).toLocaleString()} {state.currentBond.campaign.tokenname}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <p>No investors available.</p>
                                )}
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Coupon Dates</label>
                                {state.bondHolders.couponDates.length > 0 ? (
                                    <table className="w-full border border-gray-300 mt-2">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border p-2">Coupon Index</th>
                                                <th className="border p-2">Coupon Dates</th>
                                                <th className="border p-2">Paid</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {state.bondHolders.couponDates.map((coupon, index) => (
                                                <tr key={index}>
                                                    <td className="border p-2">{coupon.couponIndex}</td>
                                                    <td className="border p-2">{new Date(coupon.date).toLocaleDateString()}</td>
                                                    <td className="border p-2">{coupon.paid ? "Yes" : "No"}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <p>No coupon dates available.</p>
                                )}
                            </div>
                            <div className="flex space-x-2">
                                <button
                                    type="button"
                                    onClick={triggerBondCouponPayment}
                                    disabled={!state.currentBond.smartcontractaddress}
                                    className={`py-2 px-4 rounded-md text-white ${!state.currentBond.smartcontractaddress ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    Trigger Coupon Payment
                                </button>
                                <button
                                    type="button"
                                    onClick={() => window.history.back()}
                                    className="py-2 px-4 rounded-md bg-gray-500 text-white hover:bg-gray-600"
                                >
                                    Back
                                </button>
                            </div>
                        </form>
                    </div>
                    {state.showm && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <p>{state.modalmsg}</p>
                                <button onClick={hideModal} className="mt-4 py-2 px-4 bg-blue-600 text-white rounded-md">
                                    {state.button0text}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>